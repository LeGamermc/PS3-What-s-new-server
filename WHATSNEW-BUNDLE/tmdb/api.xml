#!/usr/bin/env python3
import os
import sys
from urllib.parse import parse_qs

def main():
    # Get query string from environment
    query_string = os.environ.get('QUERY_STRING', '')
    
    # Parse query parameters
    params = parse_qs(query_string)
    
    # Get the 'p' parameter
    p_value = params.get('p', [''])[0]
    
    if not p_value:
        print("Status: 400 Bad Request\r")
        print("Content-Type: text/plain\r")
        print("\r")
        print("Error: Missing 'p' parameter")
        sys.exit(1)
    
    # Split the parameter by hyphen
    parts = p_value.split('-')
    
    if len(parts) != 3:
        print("Status: 400 Bad Request\r")
        print("Content-Type: text/plain\r")
        print("\r")
        print("Error: Parameter 'p' must be in format VAL1-VAL2-VAL3")
        sys.exit(1)
    
    val1, val2, val3 = parts
    
    if not os.path.exists(f"/var/www/html/tmdb/{val2}.xml"):
        os.system(f"wget 'http://tmdb.{val1}.dl.playstation.net/tmdb/{val2}_{val3}/{val2}.xml' -O '/var/www/html/tmdb/{val2}.xml'")

        os.system(f"wget http://tmdb.{val1}.dl.playstation.net/tmdb/{val2}_{val3}/ICON0.PNG -O '/var/www/html/tmdb/images/{val2}.png'")
        
        os.system(f"sed -i 's|<icon type=\"320x176\">[^<]*</icon>|<icon type=\"320x176\">http://kns-srv2.zapto.org:82/tmdb/images/{val2}.png</icon>|g' '/var/www/html/tmdb/{val2}.xml'")
        redirect_url = f"http://tmdb.{val1}.dl.playstation.net/tmdb/{val2}_{val3}/{val2}.xml"
    else:
        redirect_url = f"http://kns-srv2.zapto.org:82/tmdb/{val2}.xml"
    
    print(f"Status: 302 Found\r")
    print(f"Location: {redirect_url}\r")
    print("\r")

if __name__ == "__main__":
    main()
